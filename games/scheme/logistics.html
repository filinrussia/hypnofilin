<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–õ–æ–≥–∏—Å—Ç–∏–∫–∞ ‚Ä¢ –ì–∏–ø–Ω–æ–§–∏–ª—ñ–Ω</title>
    <link rel="icon" type="image/png" sizes="48x48" href="/favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: #0d0d10;
            color: rgba(255, 255, 255, 0.95);
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        .header {
            padding: 16px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .page-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.5);
        }

        /* –í–∫–ª–∞–¥–∫–∏ */
        .tabs {
            display: flex;
            padding: 12px 16px;
            gap: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .tab.active {
            background: linear-gradient(135deg, #0a84ff 0%, #0066cc 100%);
            color: white;
            border-color: #0a84ff;
        }

        /* –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ */
        .tab-content {
            display: none;
            padding: 16px;
        }

        .tab-content.active {
            display: block;
        }

        /* –ö–∞—Ç–µ–≥–æ—Ä–∏—è */
        .category-section {
            margin-bottom: 24px;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .category-emoji {
            font-size: 24px;
        }

        .category-title {
            font-size: 18px;
            font-weight: 600;
            flex: 1;
        }

        .add-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #0a84ff 0%, #0066cc 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        /* –°–ø–∏—Å–æ–∫ –º–µ—Å—Ç */
        .places-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
        }

        .place-card {
            background: rgba(255, 255, 255, 0.06);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .place-card.in-route {
            border-color: #0a84ff;
            background: rgba(10, 132, 255, 0.15);
        }

        .place-card.in-route::after {
            content: attr(data-route-number);
            position: absolute;
            top: -8px;
            right: -8px;
            width: 28px;
            height: 28px;
            background: #0a84ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            color: white;
        }

        .place-name {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.95);
        }

        .place-rating {
            font-size: 12px;
            color: #0a84ff;
        }

        .place-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(255, 50, 50, 0.2);
            border: none;
            border-radius: 50%;
            color: rgba(255, 100, 100, 0.9);
            font-size: 16px;
            cursor: pointer;
            display: none;
        }

        .place-card:active {
            transform: scale(0.95);
        }

        /* –ö–∞—Ä—Ç–∞ */
        .map-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 16px;
            position: relative;
        }

        #mapCanvas {
            display: block;
            width: 100%;
            height: 400px;
            touch-action: none;
        }

        .map-legend {
            display: flex;
            gap: 16px;
            padding: 12px 16px;
            justify-content: center;
            flex-wrap: wrap;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å –º–∞—Ä—à—Ä—É—Ç–∞ */
        .route-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(13, 13, 16, 0.98);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px;
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .route-panel.active {
            transform: translateY(0);
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .route-title {
            font-size: 16px;
            font-weight: 600;
        }

        .route-clear {
            padding: 6px 12px;
            background: rgba(255, 50, 50, 0.2);
            border: none;
            border-radius: 6px;
            color: rgba(255, 100, 100, 0.9);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .route-list {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
            margin-bottom: 12px;
        }

        .route-item {
            min-width: 120px;
            padding: 10px;
            background: rgba(10, 132, 255, 0.15);
            border: 1px solid rgba(10, 132, 255, 0.3);
            border-radius: 8px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .route-item-number {
            width: 20px;
            height: 20px;
            background: #0a84ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .route-item-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .route-item-remove {
            width: 20px;
            height: 20px;
            background: rgba(255, 50, 50, 0.3);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            cursor: pointer;
            flex-shrink: 0;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.show {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 40px;
        }

        .modal-content {
            background: rgba(13, 13, 16, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 500px;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .modal-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.5);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.85);
        }

        .form-input, .form-textarea {
            width: 100%;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 14px;
            font-size: 16px;
            color: rgba(255, 255, 255, 0.95);
            font-family: inherit;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #0a84ff;
            background: rgba(255, 255, 255, 0.08);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .rating-group {
            margin-bottom: 20px;
        }

        .rating-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .rating-scale {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .rating-btn {
            padding: 14px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .rating-btn.active {
            background: linear-gradient(135deg, #0a84ff 0%, #0066cc 100%);
            border-color: #0a84ff;
            color: white;
        }

        .modal-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-btn {
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .modal-btn-cancel {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.85);
        }

        .modal-btn-submit {
            background: linear-gradient(135deg, #0a84ff 0%, #0066cc 100%);
            color: white;
        }

        /* –†–µ–∂–∏–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ */
        .route-mode-banner {
            padding: 12px 16px;
            background: linear-gradient(135deg, #0a84ff 0%, #0066cc 100%);
            color: white;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            display: none;
        }

        .route-mode-banner.active {
            display: block;
        }

        .info-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(13, 13, 16, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            max-width: 300px;
            display: none;
            z-index: 1500;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        }

        .info-panel.show {
            display: block;
        }

        .info-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .info-criteria {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .info-criterion {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }

        .info-criterion-name {
            color: rgba(255, 255, 255, 0.65);
        }

        .info-stars {
            color: #0a84ff;
        }

        .info-description {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            font-size: 12px;
            color: rgba(255, 255, 255, 0.55);
            line-height: 1.5;
        }

        @media (min-width: 768px) {
            body {
                padding-bottom: 0;
            }

            .page-title {
                font-size: 32px;
            }

            #mapCanvas {
                height: 500px;
            }

            .route-panel {
                position: static;
                transform: none;
                background: rgba(255, 255, 255, 0.04);
                border: 1px solid rgba(255, 255, 255, 0.08);
                border-radius: 16px;
                margin: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="page-title">–ö–∞—Ä—Ç–∞ –ª–æ–≥–∏—Å—Ç–∏–∫–∏</h1>
        <p class="page-subtitle">–ü–ª–∞–Ω–∏—Ä—É–π —Å–≤–æ–π –º–∞—Ä—à—Ä—É—Ç</p>
    </div>

    <div class="route-mode-banner" id="routeModeBanner">
        üìç –†–µ–∂–∏–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ ‚Ä¢ –¢–∞–ø–∞–π –ø–æ –º–µ—Å—Ç–∞–º
    </div>

    <div class="tabs">
        <div class="tab active" data-tab="map">üó∫Ô∏è –ö–∞—Ä—Ç–∞</div>
        <div class="tab" data-tab="places">üìç –ú–µ—Å—Ç–∞</div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞: –ö–∞—Ä—Ç–∞ -->
    <div class="tab-content active" id="mapTab">
        <div class="map-container">
            <canvas id="mapCanvas"></canvas>
        </div>
        <div class="map-legend">
            <div class="legend-item">
                <div class="legend-dot" style="background: #4CAF50;"></div>
                <span>–ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #2196F3;"></div>
                <span>–û–±—â–µ–Ω–∏–µ</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #FF5722;"></div>
                <span>–°–µ–∫—Å</span>
            </div>
        </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞: –ú–µ—Å—Ç–∞ -->
    <div class="tab-content" id="placesTab">
        <div class="category-section">
            <div class="category-header">
                <span class="category-emoji">üëã</span>
                <h2 class="category-title">–ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ</h2>
                <button class="add-btn" onclick="openAddModal('meet')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <div class="places-grid" id="meetPlaces"></div>
        </div>

        <div class="category-section">
            <div class="category-header">
                <span class="category-emoji">üí¨</span>
                <h2 class="category-title">–û–±—â–µ–Ω–∏–µ</h2>
                <button class="add-btn" onclick="openAddModal('talk')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <div class="places-grid" id="talkPlaces"></div>
        </div>

        <div class="category-section">
            <div class="category-header">
                <span class="category-emoji">üî•</span>
                <h2 class="category-title">–°–µ–∫—Å</h2>
                <button class="add-btn" onclick="openAddModal('sex')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <div class="places-grid" id="sexPlaces"></div>
        </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –º–∞—Ä—à—Ä—É—Ç–∞ -->
    <div class="route-panel" id="routePanel">
        <div class="route-header">
            <div class="route-title">–ú–∞—Ä—à—Ä—É—Ç</div>
            <button class="route-clear" onclick="clearRoute()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div class="route-list" id="routeList"></div>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="info-panel" id="infoPanel"></div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ</h2>
                <p class="modal-subtitle" id="modalSubtitle">–û—Ü–µ–Ω–∏—Ç–µ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º</p>
            </div>
            <form id="addPlaceForm">
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ *</label>
                    <input type="text" class="form-input" id="placeName" required maxlength="30" placeholder="–ë–æ–ª—å—à–∞—è –ü–æ–∫—Ä–æ–≤—Å–∫–∞—è">
                </div>
                <div id="criteriaContainer"></div>
                <div class="modal-actions">
                    <button type="button" class="modal-btn modal-btn-cancel" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="modal-btn modal-btn-submit">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // === –ö—Ä–∏—Ç–µ—Ä–∏–∏ ===
        const criteria = {
            meet: [
                { id: 'capacity', label: '–Å–º–∫–æ—Å—Ç—å', description: '–°–∫–æ–ª—å–∫–æ –ª—é–¥–µ–π' },
                { id: 'openness', label: '–õ—ë–≥–∫–æ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç–∏—è', description: '–õ–µ–≥–∫–æ –Ω–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä' },
                { id: 'context', label: '–ö–æ–Ω—Ç–µ–∫—Å—Ç', description: '–û —á—ë–º –≥–æ–≤–æ—Ä–∏—Ç—å' }
            ],
            talk: [
                { id: 'atmosphere', label: '–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞', description: '–†–æ–º–∞–Ω—Ç–∏—á–Ω–æ/—É—é—Ç–Ω–æ' },
                { id: 'activity', label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', description: '–ß—Ç–æ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å' },
                { id: 'price', label: '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫', description: '–¶–µ–Ω–∞' }
            ],
            sex: [
                { id: 'privacy', label: '–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å', description: '–ù–µ —Å–ø–∞–ª—è—Ç' },
                { id: 'comfort', label: '–ö–æ–º—Ñ–æ—Ä—Ç', description: '–£—Å–ª–æ–≤–∏—è' },
                { id: 'availability', label: '–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å', description: '–õ–µ–≥–∫–æ –ø–æ–ø–∞—Å—Ç—å' }
            ]
        };

        // === –î–∞–Ω–Ω—ã–µ ===
        const places = {
            meet: [
                { name: '–ë–æ–ª—å—à–∞—è –ü–æ–∫—Ä–æ–≤—Å–∫–∞—è', x: 150, y: 100, ratings: { capacity: 4, openness: 3, context: 4 }, description: '–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —É–ª–∏—Ü–∞' },
                { name: '–ü–∞—Ä–∫ –®–≤–µ–π—Ü–∞—Ä–∏—è', x: 200, y: 150, ratings: { capacity: 3, openness: 4, context: 5 }, description: '–°–ø–æ–∫–æ–π–Ω–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞' }
            ],
            talk: [
                { name: '–ë–∞—Ä –ö–æ–π–æ—Ç', x: 400, y: 200, ratings: { atmosphere: 4, activity: 3, price: 3 }, description: '–ñ–∏–≤–∞—è –º—É–∑—ã–∫–∞, —Ç–∞–Ω—Ü—ã', averageCheck: 2000 },
                { name: '–ë–∞—Ä –ò—Å–∫—Ä—ã', x: 450, y: 250, ratings: { atmosphere: 5, activity: 2, price: 4 }, description: '–£—é—Ç–Ω—ã–π –±–∞—Ä', averageCheck: 3000 }
            ],
            sex: [
                { name: '–î–æ–º–∞', x: 700, y: 300, ratings: { privacy: 5, comfort: 5, availability: 4 }, description: '–ö–ª–∞—Å—Å–∏–∫–∞' }
            ]
        };

        const colors = {
            meet: '#4CAF50',
            talk: '#2196F3',
            sex: '#FF5722'
        };

        let route = []; // –ú–∞—Å—Å–∏–≤ –º–µ—Å—Ç –≤ –º–∞—Ä—à—Ä—É—Ç–µ
        let currentCategory = null;
        let draggedPoint = null;
        let canvas, ctx;

        // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
        window.addEventListener('load', () => {
            canvas = document.getElementById('mapCanvas');
            ctx = canvas.getContext('2d');

            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            renderPlaces();
            drawMap();

            // –°–æ–±—ã—Ç–∏—è canvas
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);

            // –í–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // –§–æ—Ä–º–∞
            document.getElementById('addPlaceForm').addEventListener('submit', handleFormSubmit);

            // –ö–ª–∏–∫ –ø–æ –º–æ–¥–∞–ª–∫–µ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
            document.getElementById('addModal').addEventListener('click', (e) => {
                if (e.target.id === 'addModal') closeModal();
            });

            // –ö–ª–∏–∫ –≤–Ω–µ –∏–Ω—Ñ–æ –ø–∞–Ω–µ–ª–∏
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.info-panel') && !e.target.closest('canvas')) {
                    hideInfoPanel();
                }
            });
        });

        function resizeCanvas() {
            const wrapper = canvas.parentElement;
            canvas.width = wrapper.offsetWidth;
            canvas.height = window.innerWidth < 768 ? 400 : 500;
            drawMap();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // === –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ ===
        function openAddModal(category) {
            currentCategory = category;
            const titles = {
                meet: '–ú–µ—Å—Ç–æ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞',
                talk: '–ú–µ—Å—Ç–æ –æ–±—â–µ–Ω–∏—è',
                sex: '–ú–µ—Å—Ç–æ —Å–µ–∫—Å–∞'
            };

            document.getElementById('modalTitle').textContent = titles[category];
            document.getElementById('modalSubtitle').textContent = '–û—Ü–µ–Ω–∏—Ç–µ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º –æ—Ç 1 –¥–æ 5';
            document.getElementById('placeName').value = '';

            const container = document.getElementById('criteriaContainer');
            container.innerHTML = '';

            criteria[category].forEach(criterion => {
                const group = document.createElement('div');
                group.className = 'rating-group';
                group.innerHTML = `
                    <label class="rating-label">${criterion.label} ‚Äî ${criterion.description}</label>
                    <div class="rating-scale">
                        ${[1,2,3,4,5].map(i => `
                            <button type="button" class="rating-btn" data-criterion="${criterion.id}" data-value="${i}" onclick="selectRating('${criterion.id}', ${i})">${i}</button>
                        `).join('')}
                    </div>
                `;
                container.appendChild(group);
            });

            if (category === 'meet' || category === 'talk') {
                const descGroup = document.createElement('div');
                descGroup.className = 'form-group';
                descGroup.innerHTML = `
                    <label class="form-label">${category === 'meet' ? '–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞' : '–ß—Ç–æ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å'}</label>
                    <textarea class="form-textarea" id="placeDescription" placeholder="${category === 'meet' ? '–õ—é–¥–∏ –≥—É–ª—è—é—Ç —Å —Å–æ–±–∞–∫–∞–º–∏' : '–ì—É–ª—è—Ç—å, —Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–∫–∞—Ç'}"></textarea>
                `;
                container.appendChild(descGroup);
            }

            if (category === 'talk') {
                const priceGroup = document.createElement('div');
                priceGroup.className = 'form-group';
                priceGroup.innerHTML = `
                    <label class="form-label">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (‚ÇΩ)</label>
                    <input type="number" class="form-input" id="averageCheck" placeholder="2000" min="0" step="100">
                `;
                container.appendChild(priceGroup);
            }

            document.getElementById('addModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('addModal').classList.remove('show');
        }

        function selectRating(criterionId, value) {
            document.querySelectorAll(`[data-criterion="${criterionId}"]`).forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.value) === value);
            });
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('placeName').value.trim();
            if (!name) return;

            const ratings = {};
            criteria[currentCategory].forEach(criterion => {
                const activeBtn = document.querySelector(`[data-criterion="${criterion.id}"].active`);
                ratings[criterion.id] = activeBtn ? parseInt(activeBtn.dataset.value) : 3;
            });

            let x, y;
            if (currentCategory === 'meet') {
                x = 100 + Math.random() * 200;
                y = 100 + Math.random() * 200;
            } else if (currentCategory === 'talk') {
                x = 350 + Math.random() * 200;
                y = 150 + Math.random() * 200;
            } else {
                x = 600 + Math.random() * 150;
                y = 200 + Math.random() * 200;
            }

            const place = { name, x, y, ratings };

            const descField = document.getElementById('placeDescription');
            if (descField) place.description = descField.value.trim();

            const checkField = document.getElementById('averageCheck');
            if (checkField) place.averageCheck = parseInt(checkField.value) || 0;

            places[currentCategory].push(place);

            closeModal();
            renderPlaces();
            drawMap();
        }

        // === –†–µ–Ω–¥–µ—Ä –º–µ—Å—Ç ===
        function renderPlaces() {
            ['meet', 'talk', 'sex'].forEach(category => {
                const container = document.getElementById(category + 'Places');
                container.innerHTML = '';

                places[category].forEach((place, index) => {
                    const routeIndex = route.findIndex(r => r.category === category && r.index === index);
                    const inRoute = routeIndex !== -1;

                    const card = document.createElement('div');
                    card.className = 'place-card';
                    if (inRoute) {
                        card.classList.add('in-route');
                        card.dataset.routeNumber = routeIndex + 1;
                    }

                    const avgRating = Object.values(place.ratings).reduce((a, b) => a + b, 0) / Object.values(place.ratings).length;

                    card.innerHTML = `
                        <div class="place-name">${place.name}</div>
                        <div class="place-rating">${'‚òÖ'.repeat(Math.round(avgRating))}</div>
                        <button class="place-remove" onclick="removePlace('${category}', ${index})">√ó</button>
                    `;

                    card.addEventListener('click', () => togglePlaceInRoute(category, index));
                    card.addEventListener('touchstart', (e) => {
                        const touch = e.touches[0];
                        const rect = card.getBoundingClientRect();
                        if (touch.clientX > rect.right - 40 && touch.clientY < rect.top + 40) {
                            e.stopPropagation();
                            card.querySelector('.place-remove').style.display = 'block';
                        }
                    });

                    container.appendChild(card);
                });
            });

            renderRoutePanel();
        }

        function togglePlaceInRoute(category, index) {
            const existingIndex = route.findIndex(r => r.category === category && r.index === index);

            if (existingIndex !== -1) {
                route.splice(existingIndex, 1);
            } else {
                route.push({ category, index, place: places[category][index] });
            }

            renderPlaces();
            drawMap();
        }

        function removePlace(category, index) {
            places[category].splice(index, 1);
            route = route.filter(r => !(r.category === category && r.index === index));
            renderPlaces();
            drawMap();
        }

        function renderRoutePanel() {
            const panel = document.getElementById('routePanel');
            const list = document.getElementById('routeList');
            const banner = document.getElementById('routeModeBanner');

            if (route.length > 0) {
                panel.classList.add('active');
                banner.classList.add('active');
            } else {
                panel.classList.remove('active');
                banner.classList.remove('active');
            }

            list.innerHTML = route.map((r, i) => `
                <div class="route-item">
                    <div class="route-item-number">${i + 1}</div>
                    <div class="route-item-name">${r.place.name}</div>
                    <button class="route-item-remove" onclick="removeFromRoute(${i})">√ó</button>
                </div>
            `).join('');
        }

        function removeFromRoute(index) {
            route.splice(index, 1);
            renderPlaces();
            drawMap();
        }

        function clearRoute() {
            route = [];
            renderPlaces();
            drawMap();
        }

        // === –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ä—Ç—ã ===
        function drawMap() {
            if (!ctx) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (route.length > 1) drawRoute();
            drawPoints();
        }

        function drawRoute() {
            ctx.strokeStyle = 'rgba(10, 132, 255, 0.6)';
            ctx.lineWidth = 3;
            ctx.setLineDash([10, 5]);
            ctx.beginPath();
            ctx.moveTo(route[0].place.x, route[0].place.y);
            for (let i = 1; i < route.length; i++) {
                ctx.lineTo(route[i].place.x, route[i].place.y);
            }
            ctx.stroke();
            ctx.setLineDash([]);

            for (let i = 1; i < route.length; i++) {
                drawArrow(route[i-1].place.x, route[i-1].place.y, route[i].place.x, route[i].place.y);
            }
        }

        function drawArrow(x1, y1, x2, y2) {
            const angle = Math.atan2(y2 - y1, x2 - x1);
            const size = 12;
            const mx = (x1 + x2) / 2;
            const my = (y1 + y2) / 2;

            ctx.fillStyle = 'rgba(10, 132, 255, 0.8)';
            ctx.beginPath();
            ctx.moveTo(mx, my);
            ctx.lineTo(mx - size * Math.cos(angle - Math.PI / 6), my - size * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(mx - size * Math.cos(angle + Math.PI / 6), my - size * Math.sin(angle + Math.PI / 6));
            ctx.closePath();
            ctx.fill();
        }

        function drawPoints() {
            ['meet', 'talk', 'sex'].forEach(category => {
                places[category].forEach((place, index) => {
                    const routeIndex = route.findIndex(r => r.category === category && r.index === index);
                    const inRoute = routeIndex !== -1;
                    const radius = inRoute ? 16 : 12;

                    ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                    ctx.shadowBlur = 8;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 2;

                    ctx.fillStyle = colors[category];
                    ctx.beginPath();
                    ctx.arc(place.x, place.y, radius, 0, Math.PI * 2);
                    ctx.fill();

                    if (inRoute) {
                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.9)';
                        ctx.lineWidth = 3;
                        ctx.stroke();

                        // –ù–æ–º–µ—Ä
                        ctx.shadowColor = 'transparent';
                        ctx.fillStyle = 'white';
                        ctx.font = 'bold 14px -apple-system';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(routeIndex + 1, place.x, place.y);
                    }

                    ctx.shadowColor = 'transparent';
                    ctx.shadowBlur = 0;

                    // –ù–∞–∑–≤–∞–Ω–∏–µ
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
                    ctx.font = '600 13px -apple-system';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';
                    ctx.fillText(place.name, place.x, place.y - radius - 8);
                });
            });
        }

        // === –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ ===
        function getPointAt(x, y) {
            for (const category in places) {
                for (let i = 0; i < places[category].length; i++) {
                    const place = places[category][i];
                    const dist = Math.sqrt((x - place.x) ** 2 + (y - place.y) ** 2);
                    if (dist < 20) return { category, index: i, place };
                }
            }
            return null;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;

            const point = getPointAt(x, y);
            if (point) {
                showInfoPanel(point);
                draggedPoint = point;
            }
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (!draggedPoint) return;

            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;

            draggedPoint.place.x = Math.max(20, Math.min(canvas.width - 20, x));
            draggedPoint.place.y = Math.max(20, Math.min(canvas.height - 20, y));
            drawMap();
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            if (draggedPoint && e.changedTouches.length > 0) {
                const touch = e.changedTouches[0];
                const rect = canvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                const dist = Math.sqrt((x - draggedPoint.place.x) ** 2 + (y - draggedPoint.place.y) ** 2);

                if (dist < 5) {
                    togglePlaceInRoute(draggedPoint.category, draggedPoint.index);
                }
            }
            draggedPoint = null;
        }

        function handleMouseDown(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            draggedPoint = getPointAt(x, y);
            if (draggedPoint) showInfoPanel(draggedPoint);
        }

        function handleMouseMove(e) {
            if (!draggedPoint) return;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            draggedPoint.place.x = Math.max(20, Math.min(canvas.width - 20, x));
            draggedPoint.place.y = Math.max(20, Math.min(canvas.height - 20, y));
            drawMap();
        }

        function handleMouseUp() {
            draggedPoint = null;
        }

        function showInfoPanel(point) {
            const panel = document.getElementById('infoPanel');
            const place = point.place;

            let html = `<div class="info-title">${place.name}</div><div class="info-criteria">`;

            criteria[point.category].forEach(criterion => {
                const value = place.ratings[criterion.id] || 0;
                const stars = '‚òÖ'.repeat(value) + '‚òÜ'.repeat(5 - value);
                html += `
                    <div class="info-criterion">
                        <span class="info-criterion-name">${criterion.label}</span>
                        <span class="info-stars">${stars}</span>
                    </div>
                `;
            });

            html += '</div>';

            if (place.averageCheck) html += `<div class="info-description">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫: ${place.averageCheck} ‚ÇΩ</div>`;
            if (place.description) html += `<div class="info-description">${place.description}</div>`;

            panel.innerHTML = html;
            panel.classList.add('show');
        }

        function hideInfoPanel() {
            document.getElementById('infoPanel').classList.remove('show');
        }
    </script>
</body>
</html>
